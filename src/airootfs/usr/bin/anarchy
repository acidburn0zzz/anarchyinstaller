#!/bin/sh
# Copyright (C) 2017 Dylan Schacht

. libanarchy.sh
. /etc/anarchy.conf
. /usr/share/anarchy/lang/english.conf

# Starts on bootup
start_menu() {
	# Only run if the start menu hasn't been run already
	if [ ! -f /root/.anarchy_updated ]; then
		dialog --clear \
				--title 'About Anarchy Installer' \
				--msgbox "\n${start_menu_msg}\n\n${start_menu_social}" 18 80

		# Ask the user what they want to do, default to updating anarchy
		menu_choice="$(dialog --menu "What do you want to do?" 18 80 \
				"Update" "Update anarchy and start the installation" \
				"Start" "Start the installation without updating anarchy" \
				"Exit" "Exit the installer and be dropped into a shell" 3>&1 1>&2 2>&3)"

		case "${menu_choice}" in
			Update)
				if ! is_online; then
					wifi-menu -o
				fi

				# Download run the update script
				tmp_dir="$(mktemp -d)"
				curl -O https://gitlab.com/anarchyinstaller/installer/-/raw/HEAD/src/airootfs/usr/bin/anarchy-update
				chmod +x "${tmp_dir}"/anarchy-update
				./"${tmp_dir}"/anarchy-update &
				;;
			Start) touch /root/.anarchy_updated ;; # Pretend user has updated
			Exit) exit ;;
		esac
	fi
}

dialog() {
	# If terminal height is more than 25 lines add extra info at the top
	if "${screen_h}" ; then
		if "${LAPTOP}" ; then
			# Show battery charge next to Anarchy heading
			backtitle="${backtitle} $(acpi)"
		fi

		# op_title is the current menu title
		/usr/bin/dialog --colors --backtitle "${backtitle}" \
				--title "${op_title}" "$@"
	else
		# title is the main title (Anarchy)
		/usr/bin/dialog --colors --title "${title}" "$@"
	fi
}

usage() {
	echo 'Usage: anarchy [option]'
	echo '    -h | --help      Show this message'
	echo '    -u | --update    Update Anarchy'
}

init() {
	# Prevents the installer from exiting if Ctrl-C is pressed
	trap '' 2

	anarchy_directory='/usr/share/anarchy'

	for library in /usr/lib/anarchy/*; do
		. "${library}"
	done

	language
	. "${lang_file}"
	export reload=true
}

main() {
	if [ "$(id -u)" -ne 0 ]; then
		echo "Error: $0 requires root privileges"
		echo "    Use: sudo $0"
		exit 1
	fi

	start_menu
	set_keys
	update_mirrors
	check_connection
	set_locale
	set_zone
	prepare_drives
	install_options
	set_hostname
	set_user
	add_software
	install_base
	configure_system
	add_user
	reboot_system
}

if [ $# -eq 0 ]; then
	init
	main
else
	case "$1" in
		-h|--help) usage ;;
		-u|--update) anarchy-update ;;
		*) usage; exit 1 ;;
	esac
fi
